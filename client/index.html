<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>

    <script>
    const API_URL = 'https://e1ad1fcb-e0d6-4975-9d66-21666cc89433-00-edqcrzbbmbuj.riker.replit.dev';
    const urlParams = new URLSearchParams(window.location.search);
    const siteId = urlParams.get('site_id');

    if (siteId) {
      const SESSION = {
        siteId: siteId,
        startTime: Date.now(),
        lastActive: Date.now(),
        deviceInfo: {
          browser: navigator.userAgent,
          os: navigator.platform,
          screenSize: { width: window.screen.width, height: window.screen.height }
        },
        pageViews: [],
        clicks: [],
        navigationPath: []
      };

      // Track page view
      let maxScroll = 0;
      let pageStartTime = Date.now();

      function trackPageView() {
        const path = window.location.pathname + window.location.search;
        SESSION.pageViews.push({
          path,
          timestamp: Date.now(),
          timeSpent: Math.round((Date.now() - pageStartTime) / 1000),
          scrollDepth: maxScroll,
          deviceInfo: SESSION.deviceInfo,
          location: {
            country: 'US', // You might want to use a geolocation service here
            region: 'AR'
          }
        });
        SESSION.navigationPath.push(path);
      }

      // Track initial page view
      trackPageView();

      // Track scroll
      document.addEventListener('scroll', () => {
        const scrollPercent = Math.round((window.scrollY + window.innerHeight) / document.documentElement.scrollHeight * 100);
        maxScroll = Math.max(maxScroll, scrollPercent);
      });

      // Track clicks
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (target instanceof HTMLElement) {
          SESSION.clicks.push({
            path: window.location.pathname + window.location.search,
            timestamp: Date.now(),
            elementId: target.id || '',
            elementText: target.innerText || '',
            position: {
              x: e.clientX,
              y: e.clientY
            }
          });
        }
      });

      // Record initial visit
      fetch(`${API_URL}/api/businesses/${siteId}/visits`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Origin': window.location.origin
        },
        mode: 'cors',
        body: JSON.stringify({
          duration: 0,
          source: document.referrer || 'direct'
        })
      }).catch(e => console.warn('Initial visit recording failed:', e));

      // Send data before page unload
      window.addEventListener('beforeunload', () => {
        // Update final page view data
        SESSION.pageViews[SESSION.pageViews.length - 1].timeSpent = 
          Math.round((Date.now() - pageStartTime) / 1000);
        SESSION.pageViews[SESSION.pageViews.length - 1].scrollDepth = maxScroll;

        const visitData = new Blob([JSON.stringify({
          duration: Math.round((Date.now() - SESSION.startTime) / 1000),
          source: document.referrer || 'direct'
        })], { type: 'application/json' });

        const analyticsData = new Blob([JSON.stringify(SESSION)], { type: 'application/json' });

        navigator.sendBeacon(`${API_URL}/api/businesses/${siteId}/visits`, visitData);
        navigator.sendBeacon(`${API_URL}/api/businesses/${siteId}/analytics`, analyticsData);
      });
    }
    </script>
  </body>
</html>
